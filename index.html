<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Trend Spotter (Calculus Edition)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* --- STYLING (Tampilan Gelap & Modern) --- */
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Segoe UI', sans-serif; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .status-badge { background: #065f46; color: #34d399; padding: 5px 12px; border-radius: 20px; font-size: 0.8rem; }

        /* Panel Kontrol */
        .controls { background: #1e293b; padding: 20px; border-radius: 12px; margin-bottom: 20px; display: flex; gap: 15px; align-items: center; border: 1px solid #334155; flex-wrap: wrap; }
        select, button { padding: 10px 15px; border-radius: 6px; border: 1px solid #475569; background: #0f172a; color: white; cursor: pointer; }
        button { background-color: #2563eb; border-color: #2563eb; font-weight: 600; }
        button:hover { background-color: #1d4ed8; }
        
        /* Grid Layout */
        .charts-grid { display: grid; grid-template-columns: 1fr; gap: 20px; }
        .chart-card { background: #1e293b; padding: 20px; border-radius: 12px; border: 1px solid #334155; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        
        h2 { margin-top: 0; font-size: 0.9rem; color: #94a3b8; text-transform: uppercase; letter-spacing: 1px; }
        .value-display { font-size: 2.5rem; font-weight: bold; margin: 10px 0; }
        .sub-text { font-size: 0.9rem; opacity: 0.8; }
        
        /* Warna Indikator */
        .bullish { color: #34d399; } /* Hijau */
        .bearish { color: #f87171; } /* Merah */
        .neutral { color: #94a3b8; } /* Abu */
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>Crypto Trend Spotter <span style="font-size:0.6em; color:#94a3b8; font-weight:normal;">(Calculus Normalized)</span></h1>
        <span class="status-badge">‚óè API Source: CoinGecko</span>
    </div>

    <div class="controls">
        <div>
            <label style="font-size: 0.8rem; color: #94a3b8; display:block; margin-bottom:4px">Aset Kripto</label>
            <select id="coinId">
                <option value="bitcoin">Bitcoin (BTC)</option>
                <option value="ethereum">Ethereum (ETH)</option>
                <option value="solana">Solana (SOL)</option>
                <option value="ripple">XRP (XRP)</option>
                <option value="cardano">Cardano (ADA)</option>
            </select>
        </div>
        <div>
            <label style="font-size: 0.8rem; color: #94a3b8; display:block; margin-bottom:4px">Metode Diferensiasi</label>
            <select id="diffMethod">
                <option value="central">Hybrid (Central + Backward)</option>
                <option value="backward">Backward Only</option>
            </select>
        </div>
        <div style="display: flex; align-items: center; margin-top: 18px;">
            <input type="checkbox" id="useSmoothing" style="margin-right: 8px;"> 
            <label for="useSmoothing">Smoothing (SMA)</label>
        </div>
        <div style="margin-left: auto; margin-top: 18px;">
            <button onclick="fetchAndCalculate()">Analisis Sekarang</button>
        </div>
    </div>

    <div class="charts-grid">
        <div class="chart-card">
            <h2>Grafik Harga (Interactive)</h2>
            <canvas id="priceChart" height="100"></canvas>
            <p style="font-size: 0.8rem; color: #64748b; margin-top: 10px;">
                üí° <b>Tips:</b> Arahkan kursor (hover) pada grafik untuk melihat analisis kalkulus pada momen tersebut.
            </p>
        </div>

        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
            <div class="chart-card">
                <h2>Velocity (Kecepatan %)</h2>
                <div id="v-value" class="value-display">--</div>
                <div id="v-desc" class="sub-text">Menunggu data...</div>
            </div>
            <div class="chart-card">
                <h2>Acceleration (Percepatan %)</h2>
                <div id="a-value" class="value-display">--</div>
                <div id="a-desc" class="sub-text">Menunggu data...</div>
            </div>
            <div class="chart-card">
                <h2>Kesimpulan Momentum</h2>
                <div id="trend-value" class="value-display" style="font-size: 1.8rem;">--</div>
                <div class="progress-bar" style="height: 6px; background: #334155; border-radius: 3px; margin-top: 15px;">
                    <div id="confidence-bar" style="width: 0%; height: 100%; background: #34d399; border-radius: 3px; transition: width 0.3s;"></div>
                </div>
                <div style="font-size: 0.7rem; color: #64748b; margin-top:5px;">Power / Confidence Level</div>
            </div>
        </div>

        <div class="chart-card">
            <h2>Grafik Turunan (Normalized Percentage)</h2>
            <canvas id="derivativeChart" height="100"></canvas>
        </div>
    </div>
</div>

<script>
    let priceChartInstance = null;
    let derivativeChartInstance = null;
    let globalData = null; // Menyimpan data untuk fitur "Snap Back" setelah hover

    // --- 1. FETCH DATA ---
    async function getCoinGeckoData() {
        const coinId = document.getElementById('coinId').value;
        const url = `https://api.coingecko.com/api/v3/coins/${coinId}/ohlc?vs_currency=usd&days=1`;
        
        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error("Limit API tercapai / Gagal. Coba lagi nanti.");
            const rawData = await response.json();
            // Format: [time, open, high, low, close]
            return rawData.map(d => ({
                time: new Date(d[0]).toLocaleTimeString('id-ID', {hour: '2-digit', minute:'2-digit'}),
                price: d[4] 
            }));
        } catch (error) {
            alert("Error: " + error.message);
            return [];
        }
    }

    // --- 2. SMOOTHING (SMA) ---
    function applySmoothing(data, windowSize = 3) {
        if (data.length < windowSize) return data;
        let smoothedData = [];
        for (let i = 0; i < data.length; i++) {
            if (i < windowSize - 1) {
                smoothedData.push(data[i]);
            } else {
                let sum = 0;
                for (let j = 0; j < windowSize; j++) sum += data[i - j].price;
                smoothedData.push({ time: data[i].time, price: sum / windowSize });
            }
        }
        return smoothedData;
    }

    // --- 3. CORE CALCULUS LOGIC (NORMALIZED %) ---
    function calculateCalculus(data, method) {
        let results = [];
        const dt = 1;

        for (let i = 0; i < data.length; i++) {
            let velocity = 0;
            let acceleration = 0;
            let currentPrice = data[i].price;
            
            let hasPrev = i > 0;
            let hasNext = i < data.length - 1;
            let hasPrev2 = i > 1; 

            // A. VELOCITY (dalam %)
            if (method === 'central' && hasPrev && hasNext) {
                // Central: Menggunakan data depan & belakang
                let deltaPrice = (data[i+1].price - data[i-1].price) / (2 * dt);
                velocity = (deltaPrice / data[i-1].price) * 100;
            } else if (hasPrev) { 
                // Backward: Menggunakan data sekarang & belakang (Fallback untuk data terakhir)
                let deltaPrice = (currentPrice - data[i-1].price) / dt;
                velocity = (deltaPrice / data[i-1].price) * 100;
            }

            // B. ACCELERATION (Perubahan Velocity %)
            if (hasPrev && hasNext) {
                 // Hitung velocity lokal next & prev untuk mendapatkan akselerasi central
                 let v_next = ((data[i+1].price - currentPrice) / currentPrice) * 100;
                 let v_prev = ((currentPrice - data[i-1].price) / data[i-1].price) * 100;
                 acceleration = (v_next - v_prev) / dt;
                 
            } else if (!hasNext && hasPrev2) {
                // Backward Difference Khusus Data Terakhir (Agar tidak 0)
                let v_now = ((currentPrice - data[i-1].price) / data[i-1].price) * 100;
                let v_prev_step = ((data[i-1].price - data[i-2].price) / data[i-2].price) * 100;
                acceleration = (v_now - v_prev_step) / dt;
            }

            results.push({ ...data[i], velocity, acceleration });
        }
        return results;
    }

    // --- 4. UPDATE UI KARTU (Dinamis) ---
    function updateCards(dataPoint) {
        if (!dataPoint) return;

        // Velocity
        const vEl = document.getElementById('v-value');
        vEl.innerText = (dataPoint.velocity > 0 ? "+" : "") + dataPoint.velocity.toFixed(2) + "%";
        vEl.className = 'value-display ' + (dataPoint.velocity >= 0 ? 'bullish' : 'bearish');
        document.getElementById('v-desc').innerText = dataPoint.velocity >= 0 ? "Tren Harga Naik" : "Tren Harga Turun";

        // Acceleration
        const aEl = document.getElementById('a-value');
        aEl.innerText = (dataPoint.acceleration > 0 ? "+" : "") + dataPoint.acceleration.toFixed(2) + "%";
        aEl.className = 'value-display ' + (dataPoint.acceleration >= 0 ? 'bullish' : 'bearish');

        // Logic Momentum Text
        let momentumText = "";
        if (dataPoint.velocity > 0 && dataPoint.acceleration > 0) momentumText = "Momentum Menguat (Strong) üöÄ";
        else if (dataPoint.velocity > 0 && dataPoint.acceleration < 0) momentumText = "Kenaikan Melambat (Weakening) ‚ö†Ô∏è";
        else if (dataPoint.velocity < 0 && dataPoint.acceleration < 0) momentumText = "Jatuh Semakin Cepat (Crash) üîª";
        else momentumText = "Penurunan Melambat (Reversal?) üîÑ";
        document.getElementById('a-desc').innerText = momentumText;

        // Kesimpulan Tren
        const trendEl = document.getElementById('trend-value');
        const barEl = document.getElementById('confidence-bar');
        
        if (dataPoint.velocity > 0) {
            trendEl.innerText = "BULLISH";
            trendEl.className = "value-display bullish";
            barEl.style.backgroundColor = "#34d399";
        } else {
            trendEl.innerText = "BEARISH";
            trendEl.className = "value-display bearish";
            barEl.style.backgroundColor = "#f87171";
        }
        
        // Visualisasi Power (Max scale di 1% change rate agar bar terlihat penuh jika volatilitas tinggi)
        let power = Math.min(Math.abs(dataPoint.acceleration) * 100, 100); 
        barEl.style.width = power + "%";
    }

    // --- 5. RENDER UTAMA ---
    async function fetchAndCalculate() {
        let data = await getCoinGeckoData();
        if (data.length === 0) return;

        if (document.getElementById('useSmoothing').checked) {
            data = applySmoothing(data);
        }

        const method = document.getElementById('diffMethod').value;
        const finalData = calculateCalculus(data, method);
        
        // Simpan ke global variable untuk keperluan reset hover
        globalData = finalData;

        // Tampilkan data terakhir secara default
        updateCards(finalData[finalData.length - 1]);
        
        renderCharts(finalData);
    }

    function renderCharts(dataset) {
        const ctxPrice = document.getElementById('priceChart').getContext('2d');
        const ctxDiff = document.getElementById('derivativeChart').getContext('2d');
        const labels = dataset.map(d => d.time);

        // Konfigurasi Interaksi Hover
        const interactionConfig = { mode: 'index', intersect: false };
        
        // Fungsi saat hover
        const handleHover = (event, chartElement) => {
            if (chartElement.length > 0) {
                const index = chartElement[0].index;
                updateCards(dataset[index]); // Update kartu sesuai posisi mouse
            }
        };

        // Fungsi saat mouse keluar (Reset ke data terbaru)
        const handleLeave = () => {
             if(globalData) {
                 updateCards(globalData[globalData.length - 1]);
             }
        };

        // --- CHART HARGA ---
        if (priceChartInstance) priceChartInstance.destroy();
        priceChartInstance = new Chart(ctxPrice, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Price (USD)',
                    data: dataset.map(d => d.price),
                    borderColor: '#3b82f6',
                    borderWidth: 2,
                    pointRadius: 0,
                    pointHoverRadius: 6,
                    tension: 0.3
                }]
            },
            options: {
                responsive: true,
                interaction: interactionConfig,
                onHover: handleHover, // Aktifkan interaksi
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            afterLabel: function(context) {
                                const d = dataset[context.dataIndex];
                                return [`Velocity: ${d.velocity.toFixed(2)}%`, `Acceleration: ${d.acceleration.toFixed(2)}%`];
                            }
                        }
                    }
                },
                scales: { x: { display: false }, y: { grid: { color: '#334155' } } }
            },
            plugins: [{
                id: 'mouseLeaveReset',
                afterEvent(chart, args) {
                    if (args.event.type === 'mouseout') handleLeave();
                }
            }]
        });

        // --- CHART TURUNAN ---
        if (derivativeChartInstance) derivativeChartInstance.destroy();
        derivativeChartInstance = new Chart(ctxDiff, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: "Velocity (%)",
                        data: dataset.map(d => d.velocity),
                        borderColor: '#10b981',
                        borderWidth: 2,
                        pointRadius: 0,
                        pointHoverRadius: 5,
                        tension: 0.3,
                        yAxisID: 'y'
                    },
                    {
                        label: "Acceleration (%)",
                        data: dataset.map(d => d.acceleration),
                        borderColor: '#a855f7',
                        borderWidth: 2,
                        borderDash: [4, 4],
                        pointRadius: 0,
                        pointHoverRadius: 5,
                        tension: 0.3,
                        yAxisID: 'y1'
                    }
                ]
            },
            options: {
                responsive: true,
                interaction: interactionConfig,
                onHover: handleHover, // Sinkronisasi hover
                plugins: {
                    legend: { labels: { color: '#cbd5e1' } }
                },
                scales: {
                    x: { ticks: { maxTicksLimit: 8, color: '#94a3b8' }, grid: { display: false } },
                    y: { position: 'left', grid: { color: '#334155' }, title: {display:true, text:'Kecepatan (%)', color:'#94a3b8'} },
                    y1: { position: 'right', grid: { display: false }, title: {display:true, text:'Percepatan (%)', color:'#94a3b8'} }
                }
            },
            plugins: [{
                id: 'mouseLeaveResetDiff',
                afterEvent(chart, args) {
                    if (args.event.type === 'mouseout') handleLeave();
                }
            }]
        });
    }

    // Auto start
    fetchAndCalculate();
</script>

</body>
</html>
